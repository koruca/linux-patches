From d88ecf3c075efec7ce8c84a4159f4c3242a3e6b3 Mon Sep 17 00:00:00 2001
From: Hideki EIRAKU <hdk@igel.co.jp>
Date: Fri, 6 Apr 2012 17:30:09 +0900
Subject: [PATCH 23/73] sound: soc: rcar: do not restart DMA when an XRUN error occurs

---
 sound/soc/rcar/sss_pcm.c |   17 +++++++++++++----
 sound/soc/rcar/sss_pcm.h |    1 +
 2 files changed, 14 insertions(+), 4 deletions(-)

diff --git a/sound/soc/rcar/sss_pcm.c b/sound/soc/rcar/sss_pcm.c
index 4a4aefe..c9b2028 100644
--- a/sound/soc/rcar/sss_pcm.c
+++ b/sound/soc/rcar/sss_pcm.c
@@ -811,10 +811,12 @@ static void sss_dma_callback(void *data, int int_status)
 
 	snd_pcm_period_elapsed(substream);
 
-	/* next dma */
-	ret = sss_dma_control(substream);
-	if (ret == 0)
-		sss_dma_start(substream, DCMD_DNXT);
+	if (pcminfo->audio_running) {
+		/* next dma */
+		ret = sss_dma_control(substream);
+		if (ret == 0)
+			sss_dma_start(substream, DCMD_DNXT);
+	}
 
 	FNC_EXIT
 	return;
@@ -822,6 +824,7 @@ static void sss_dma_callback(void *data, int int_status)
 
 static int sss_audio_start(struct snd_pcm_substream *substream)
 {
+	struct rcar_pcm_info *pcminfo = substream->runtime->private_data;
 	int ret = 0;
 
 	FNC_ENTRY
@@ -865,15 +868,20 @@ static int sss_audio_start(struct snd_pcm_substream *substream)
 	if (ret == 0)
 		sss_ssi_start(substream);
 
+	pcminfo->audio_running = 1;
+
 	FNC_EXIT
 	return ret;
 }
 
 static int sss_audio_stop(struct snd_pcm_substream *substream)
 {
+	struct rcar_pcm_info *pcminfo = substream->runtime->private_data;
 	int ret = 0;
 
 	FNC_ENTRY
+	pcminfo->audio_running = 0;
+
 	/* dma stop */
 	sss_dma_stop(substream);
 
@@ -899,6 +907,7 @@ static struct rcar_pcm_info *sss_pcm_new_stream(int codec_id)
 	pcminfo->period      = 0;
 	pcminfo->ainfo       = &audioinfo[codec_id];
 	pcminfo->minfo       = &mixer_info[codec_id];
+	pcminfo->audio_running = 0;
 	spin_lock_init(&pcminfo->pcm_lock);
 
 	FNC_EXIT
diff --git a/sound/soc/rcar/sss_pcm.h b/sound/soc/rcar/sss_pcm.h
index 0e1ffa7..8ba6cc5 100644
--- a/sound/soc/rcar/sss_pcm.h
+++ b/sound/soc/rcar/sss_pcm.h
@@ -376,6 +376,7 @@ struct rcar_pcm_info {
 	spinlock_t pcm_lock;		/* for trigger process */
 	struct rcar_audio_info *ainfo;
 	struct rcar_mixer *minfo;
+	int audio_running;
 };
 
 struct rcar_audio_info {
-- 
1.7.0.4

