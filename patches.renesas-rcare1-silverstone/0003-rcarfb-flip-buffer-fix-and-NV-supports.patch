From 1643fa307da9939fafb58de8aad0665ecec27bfb Mon Sep 17 00:00:00 2001
From: Takanari Hayama <taki@igel.co.jp>
Date: Wed, 28 Dec 2011 10:32:08 +0900
Subject: [PATCH 03/73] rcarfb: flip buffer fix and NV supports.

---
 arch/arm/mach-rcar/board-silverstone.c |    4 +-
 drivers/video/rcarfb.c                 |  127 ++++++++++++++++++++++++++------
 include/video/rcarfb.h                 |   21 +++++-
 3 files changed, 126 insertions(+), 26 deletions(-)

diff --git a/arch/arm/mach-rcar/board-silverstone.c b/arch/arm/mach-rcar/board-silverstone.c
index d462824..7abea21 100644
--- a/arch/arm/mach-rcar/board-silverstone.c
+++ b/arch/arm/mach-rcar/board-silverstone.c
@@ -379,12 +379,12 @@ static struct rcar_reso_info rcar_reso_par = {
 		.vsp  = 809,
 	},
 	.fb_desc[0] = {
-		.caps	= RCAR_FBCAPS_NONE,
+		.caps	= RCAR_FBCAPS_YC,
 		.index1	= 0,
 		.index2	= 0,
 	},
 	.fb_desc[1] = {
-		.caps	= RCAR_FBCAPS_NONE,
+		.caps	= RCAR_FBCAPS_YC,
 		.index1	= 1,
 		.index2	= 1,
 	},
diff --git a/drivers/video/rcarfb.c b/drivers/video/rcarfb.c
index 9434063..0ea1458 100644
--- a/drivers/video/rcarfb.c
+++ b/drivers/video/rcarfb.c
@@ -122,6 +122,34 @@ static void du_wait_bit(struct rcar_du_priv *priv,
 }
 #endif
 
+
+static int care1_format_to_depth(CarE1PlaneFormat format)
+{
+	switch (format) {
+	case CARE1_FORMAT_ARGB:
+		return 32;
+	case CARE1_FORMAT_RGB16:
+	case CARE1_FORMAT_UYVY:
+	case CARE1_FORMAT_YUY2:
+		return 16;
+
+	default:
+		return 16;
+	}
+}
+
+CarE1PlaneFormat depth_to_care1_format(int depth)
+{
+	switch (depth) {
+	case 16:
+		return CARE1_FORMAT_RGB16;
+	case 32:
+		return CARE1_FORMAT_ARGB;
+	default:
+		return CARE1_FORMAT_UNKNOWN;
+	}
+}
+
 static int du_check_disp_mode(unsigned long xres, unsigned long yres)
 {
 	int mode;
@@ -170,6 +198,8 @@ static void du_set_plane(struct rcar_du_priv *priv, int plane_no)
 	struct rcar_pos_param moni, mem;
 	struct rcar_size_param disp;
 
+//	printk("%s()\n",__FUNCTION__);
+
 	pl = &priv->plane[plane_no];
 	moni = pl->moni;
 	mem = pl->mem;
@@ -209,19 +239,21 @@ static void du_set_plane_mode_planeconfig( int fb_num, struct rcar_du_priv *priv
 	int shift2 = 28 - 4 * index2;
 	int mask1  = 0x7 << shift1;
 	int mask2  = 0x7 << shift2;
-	
+
 	int alphamode = 0;
 
+//	printk("%s()\n",__FUNCTION__);
+
 	if (planeconfig->options & CARE1_PLANE_OPACITY) {
 		alphamode = PnSPIM_ALPOFF_PnMR;
 	}
 	else if (planeconfig->options & CARE1_PLANE_ALPHACHANNEL) {
-		if (planeconfig->depth == 32)
+		if (planeconfig->format == CARE1_FORMAT_ARGB)
 			alphamode = PnSPIM_TPOFF_PnMR;
 	}
 
-	printk(KERN_DEBUG "index1 %d\n", index1);
-	printk(KERN_DEBUG "index2 %d\n", index2);
+//	printk(KERN_DEBUG "index1 %d\n", index1);
+//	printk(KERN_DEBUG "index2 %d\n", index2);
 	plane1 = &priv->plane[index1];
 
 	disp1 = plane1->disp;
@@ -235,7 +267,7 @@ static void du_set_plane_mode_planeconfig( int fb_num, struct rcar_du_priv *priv
 	dshpr = du_read(priv, DSHPR);
 	dshpr &= MASK_PRIL;
 
-	if (planeconfig->depth == 16) {
+	if (care1_format_to_depth(planeconfig->format) == 16) {
 		/* In case of 16BPP, use the plane1 */
 		du_write(priv, DEFR4, BPP16_DEFR4);
 		du_write(priv, PnDDCR(index1), BPP16_DDCR);
@@ -255,10 +287,20 @@ static void du_set_plane_mode_planeconfig( int fb_num, struct rcar_du_priv *priv
 	}
 
 //	du_write(priv, DPPR, 0x00000000);
-	printk(KERN_DEBUG "DPPR 0x%08lx\n", du_read(priv,DPPR));
+//	printk(KERN_DEBUG "DPPR 0x%08lx\n", du_read(priv,DPPR));
 
 	/* for plane1 */
-	du_write(priv, PnMR(index1), MODE_16BPP_PnMR | alphamode);
+
+	switch (planeconfig->format) {
+	case CARE1_FORMAT_UYVY:
+		du_write(priv, PnMR(index1), PnBM_MD_PnMR | MODE_UYVY_PnMR | alphamode);
+		break;
+	case CARE1_FORMAT_YUY2:
+		du_write(priv, PnMR(index1), PnBM_MD_PnMR | MODE_YUY2_PnMR | alphamode);
+		break;
+	default:
+		du_write(priv, PnMR(index1), PnBM_MD_PnMR | MODE_16BPP_PnMR | alphamode);
+	}
 
 	du_write(priv, PnMWR(index1), planeconfig->width);
 
@@ -283,7 +325,7 @@ static void du_set_plane_mode_planeconfig( int fb_num, struct rcar_du_priv *priv
 	/* set register */
 	du_set_plane(priv, index1);
 
-	priv->plane[index1].plane_pixel = planeconfig->depth;
+	priv->plane[index1].plane_pixel = care1_format_to_depth(planeconfig->format);
 	priv->plane[index1].mwx = planeconfig->pitch;
 	priv->plane[index1].disp_area = DISPLAY_AREA0;
 	priv->plane[index1].disp_area0_base =
@@ -292,7 +334,7 @@ static void du_set_plane_mode_planeconfig( int fb_num, struct rcar_du_priv *priv
 //		 ((planeconfig->phys + offset) & PnDSA_MASK);
 	priv->plane_area |= plane_bit1;
 
-	if (planeconfig->depth == 32) {
+	if (planeconfig->format == CARE1_FORMAT_ARGB) {
 
 		/* for plane2 */
 		du_write(priv, PnMWR(index2), planeconfig->width);
@@ -303,8 +345,8 @@ static void du_set_plane_mode_planeconfig( int fb_num, struct rcar_du_priv *priv
 		//	du_write(priv, PnMR(index2), (PnDDDF_16BPP_PnMR | PnBM_MD_PnMR | PnSPIM_TPOFF_PnMR));
 		//}
 		//else {
-			du_write(priv, PnMR(index1), (PnDDDF_16BPP_PnMR | PnBM_MD_PnMR | alphamode));
-			du_write(priv, PnMR(index2), (PnDDDF_16BPP_PnMR | PnBM_MD_PnMR | alphamode));
+			du_write(priv, PnMR(index1), (PnBM_MD_PnMR | PnDDDF_16BPP_PnMR | alphamode));
+			du_write(priv, PnMR(index2), (PnBM_MD_PnMR | PnDDDF_16BPP_PnMR | alphamode));
 		//}
 
 		/* use the value of plane1 */
@@ -328,7 +370,7 @@ static void du_set_plane_mode_planeconfig( int fb_num, struct rcar_du_priv *priv
 		/* set register */
 		du_set_plane(priv, index2);
 
-		priv->plane[index2].plane_pixel = planeconfig->depth;
+		priv->plane[index2].plane_pixel = care1_format_to_depth(planeconfig->format);
 		priv->plane[index2].mwx = planeconfig->pitch;
 		priv->plane[index2].disp_area = DISPLAY_AREA0;
 		priv->plane[index2].disp_area0_base =
@@ -341,8 +383,8 @@ static void du_set_plane_mode_planeconfig( int fb_num, struct rcar_du_priv *priv
 		priv->plane_area &= ~plane_bit2;
 	priv->plane_area = 4;
 
-	printk(KERN_DEBUG "plane_area 0x%08lx\n", priv->plane_area);
-	printk(KERN_DEBUG "DPPR 0x%08lx\n", du_read(priv,DPPR));
+//	printk(KERN_DEBUG "plane_area 0x%08lx\n", priv->plane_area);
+//	printk(KERN_DEBUG "DPPR 0x%08lx\n", du_read(priv,DPPR));
 	return;
 
 }
@@ -371,6 +413,9 @@ static void rcar_du_start_stop(struct rcar_du_priv *priv, int start)
 	unsigned long tmp = du_read(priv, DSYSR);
 	unsigned long cpg_du_st, cpg_du_mask;
 
+//	printk("%s()\n",__FUNCTION__);
+
+
 	tmp &= ~(DRES_DSYSR | DEN_DSYSR | MASTER_DSYSR_MASK);
 	/* start or stop the DU */
 	if (start == DU_START) {
@@ -389,11 +434,14 @@ static void rcar_du_start_stop(struct rcar_du_priv *priv, int start)
 		/* Stanby DU Clock Operation */
 		writel((cpg_du_st | 0x08), IO_ADDRESS(RC_BASE_CPG + 0x34));
 	}
-	printk(KERN_DEBUG "DPPR 0x%08lx\n", du_read(priv,DPPR));
+//	printk(KERN_DEBUG "DPPR 0x%08lx\n", du_read(priv,DPPR));
 }
 
 static void rcar_du_stop(struct rcar_du_priv *priv)
 {
+
+//	printk("%s()\n",__FUNCTION__);
+
 	/* stop the lcdc */
 	rcar_du_start_stop(priv, DU_STOP);
 }
@@ -404,6 +452,9 @@ static int rcar_du_setup_clocks(struct rcar_du_priv *priv,
 	unsigned long tmp = 0;
 	unsigned long md;
 
+//	printk("%s()\n",__FUNCTION__);
+
+
 	/* DU Functionality expansion */
 	du_write(priv, DEFR, DEFAULT_DEFR);
 	du_write(priv, DEFR2, DEFAULT_DEFR2);
@@ -485,6 +536,9 @@ static int du_set_disp_timing(struct rcar_du_priv *priv, int mode)
 	int clkmode;
 	int ret = 0;
 
+//	printk("%s()\n",__FUNCTION__);
+
+
 	/* We use first plane for display timings (TODO: allow independent configuration?) */
 	info = priv->info[0];
 	clkmode = priv->dispdev->disp_par[mode].clk_sel;
@@ -512,7 +566,7 @@ static int du_set_disp_timing(struct rcar_du_priv *priv, int mode)
 
 	du_write(priv, DAPCR, 0x77730011);
 
-	printk(KERN_DEBUG "DPPR 0x%08lx\n", du_read(priv,DPPR));
+//	printk(KERN_DEBUG "DPPR 0x%08lx\n", du_read(priv,DPPR));
 	return ret;
 }
 
@@ -521,6 +575,9 @@ static int rcar_du_start(struct rcar_du_priv *priv)
 	struct fb_info *info;
 	int ret, mode;
 
+//	printk("%s()\n",__FUNCTION__);
+
+
 	/* We use first plane for display timings (TODO: allow independent configuration?) */
 	info = priv->info[0];
 	mode = du_check_disp_mode(info->var.xres, info->var.yres);
@@ -556,6 +613,9 @@ static int rcar_du_setcolreg(u_int regno,
 {
 	u32 *palette = info->pseudo_palette;
 
+//	printk("%s()\n",__FUNCTION__);
+
+
 	if (regno >= PALETTE_NR)
 		return -EINVAL;
 
@@ -586,6 +646,9 @@ static int rcar_du_setcolreg(u_int regno,
 
 static int rcar_du_blank(int blank_mode, struct fb_info *info)
 {
+
+//	printk("%s()\n",__FUNCTION__);
+
 #if RCARFB_SUPPORTBLANK
 	struct rcar_du_priv *priv = info->par;
 	unsigned long tmp = readl(IO_ADDRESS(RC_BASE_DISPLAY + DSYSR));
@@ -629,12 +692,17 @@ static int du_update_displaystart(int fb_num, struct rcar_du_priv *priv, CarE1Pl
 
 	unsigned long tmp;
 
+//	printk("%s()\n",__FUNCTION__);
+
+
 	// FIXME: set one plane only if 16bit only
 	priv->plane[index1].disp_area0_base = (planeconfig->phys & PnDSA_MASK);
 	priv->plane[index2].disp_area0_base = (planeconfig->phys & PnDSA_MASK);
 
 	du_write(priv, P1DSA0R + (index1   * PLANE_OFF), planeconfig->phys);
 	du_write(priv, P1DSA0R + ((index2) * PLANE_OFF), planeconfig->phys);
+	du_write(priv, P1DSA1R + (index1   * PLANE_OFF), planeconfig->phys);
+	du_write(priv, P1DSA1R + ((index2) * PLANE_OFF), planeconfig->phys);
 
 	/* Change frame buffer */
 	tmp = du_read(priv, PnMR(index1));	// FIXME: only for one plane?
@@ -658,6 +726,9 @@ static int rcar_du_pan_display(struct fb_var_screeninfo *var,
 
 	unsigned long tmp;
 
+//	printk("%s()\n",__FUNCTION__);
+
+
 	if (var->xoffset != priv->offset.sx ||
 		 var->yoffset != priv->offset.sy) {
 		if ((var->xoffset == 0) && ((var->yoffset == 0) ||
@@ -690,6 +761,9 @@ static int rcar_du_check_var(struct fb_var_screeninfo *var,
 
 	int fb_num = (info->fix.id[15] - '0');
 
+//	printk("%s()\n",__FUNCTION__);
+
+
 	switch (var->bits_per_pixel) {
 	case BITPARPIXEL_16:	/* RGB 565 */
 		var->red.offset    = 11;
@@ -732,6 +806,9 @@ static int rcar_du_set_par(struct fb_info *info)
 	struct fb_var_screeninfo *var = &info->var;
 	int cur_mode, new_mode, ret = 0;
 
+//	printk("%s()\n",__FUNCTION__);
+
+
 	/* We use first plane for display timings (TODO: allow independent configuration?) */
 	if (info->fix.id[15] == '0') {
 		/* check the resolution */
@@ -766,11 +843,11 @@ static int rcar_du_set_par(struct fb_info *info)
 		/* color setting */
 
 		if (var->bits_per_pixel == BITPARPIXEL_16) {
-			planeconfig->depth = 16;
+			planeconfig->format = CARE1_FORMAT_RGB16;
 			//du_set_plane_mode(priv, BITPARPIXEL_16, info);
 		} else if (var->bits_per_pixel == BITPARPIXEL_24 ||
 			   var->bits_per_pixel == BITPARPIXEL_32) {
-			planeconfig->depth = 32;
+			planeconfig->format = CARE1_FORMAT_ARGB;
 			//du_set_plane_mode(priv, BITPARPIXEL_32, info);
 		}
 		/* update param */
@@ -785,7 +862,7 @@ static int rcar_du_set_par(struct fb_info *info)
 	/* start the DU */
 	rcar_du_start_stop(priv, DU_START);
 
-	printk(KERN_DEBUG "DPPR 0x%08lx\n", du_read(priv,DPPR));
+//	printk(KERN_DEBUG "DPPR 0x%08lx\n", du_read(priv,DPPR));
 	return ret;
 
 err1:
@@ -802,6 +879,9 @@ static int rcar_ioctl (struct fb_info *info, unsigned int cmd, unsigned long arg
 	struct rcar_du_priv *priv = g_dupriv;
 	CarE1PlaneConfig config;
 
+//	printk("%s()\n",__FUNCTION__);
+
+
 	switch (cmd) {
 	case CARE1_PLANE_GET_DESCRIPTION:
 		  if(copy_to_user((struct rcar_fb_desc*)arg, &priv->dispdev->fb_desc[fb_num], sizeof(struct rcar_fb_desc))!=0)
@@ -813,11 +893,14 @@ static int rcar_ioctl (struct fb_info *info, unsigned int cmd, unsigned long arg
 		  if(copy_from_user(&config, (CarE1PlaneConfig*)arg, sizeof(CarE1PlaneConfig))!=0)
 			  return -EFAULT;
 
-		  if (config.depth > 16 && !(priv->dispdev->fb_desc[fb_num].caps & RCAR_FBCAPS_32BIT))
+		  if (care1_format_to_depth(config.format) > 16 && !(priv->dispdev->fb_desc[fb_num].caps & RCAR_FBCAPS_32BIT))
 			  return -ENOTSUPP;
 
 		  du_set_plane_mode_planeconfig( fb_num, priv, &config );
 
+		  if (config.phys != priv->planeconfig[fb_num].phys)
+			  du_update_displaystart( fb_num, priv, &config );
+
 		  priv->planeconfig[fb_num] = config;
 
 		  return 0;
@@ -981,7 +1064,7 @@ static int __devinit rcar_du_probe(struct platform_device *pdev)
 
 		info->fix.line_length = info->var.xres *
 				(info->var.bits_per_pixel / 8);
-		
+
 		if (!priv->dispdev->fb_desc[i].fb_size) {
 			if (priv->dispdev->fb_desc[i].caps & RCAR_FBCAPS_32BIT)
 				priv->dispdev->fb_desc[i].fb_size = 4 * MAX_XRES * MAX_YRES * PLANE_NUM;
@@ -1024,7 +1107,7 @@ static int __devinit rcar_du_probe(struct platform_device *pdev)
 		 /* allocate and fill advanced planeconfig struct, used by directfb and the ioctl interface */
 		 priv->planeconfig[i].width = info->var.xres;
 		 priv->planeconfig[i].height = info->var.yres;
-		 priv->planeconfig[i].depth = info->var.bits_per_pixel;
+		 priv->planeconfig[i].format = depth_to_care1_format(info->var.bits_per_pixel);
 		 priv->planeconfig[i].x = 0;
 		 priv->planeconfig[i].y = 0;
 		 priv->planeconfig[i].pitch = info->fix.line_length;
diff --git a/include/video/rcarfb.h b/include/video/rcarfb.h
index f5306a1..33278b7 100644
--- a/include/video/rcarfb.h
+++ b/include/video/rcarfb.h
@@ -30,7 +30,8 @@ struct rcar_disp_info {
 enum rcar_fb_caps {
 	RCAR_FBCAPS_NONE	= 0x00,
 	RCAR_FBCAPS_32BIT	= 0x01,
-	RCAR_FBCAPS_ALL	= 0x01,
+	RCAR_FBCAPS_YC		= 0x02,
+	RCAR_FBCAPS_ALL	= 0x03,
 };
 
 struct rcar_fb_desc {
@@ -421,10 +422,15 @@ struct rcar_reso_info {
 #define PnYCDF_YUYV_PnMR	(1<<20)	/* YUYV format */
 #define PnVISL_VIN0_PnMR	(0<<26)	/* use Video Input 0 */
 #define PnVISL_VIN1_PnMR	(1<<26)	/* use Video Input 1 */
+
 #define MODE_16BPP_PnMR		(PnDDDF_16BPP_PnMR | PnBM_MD_PnMR | \
 				 PnSPIM_TPOFF_PnMR)
 #define MODE_RGB_PnMR		(PnDDDF_ARGB_PnMR | PnBM_MD_PnMR | \
 				 PnSPIM_TPOFF_PnMR)
+#define MODE_UYVY_PnMR		(PnDDDF_YC_PnMR | PnYCDF_UYVY_PnMR | PnBM_MD_PnMR | \
+				           PnSPIM_TPOFF_PnMR)
+#define MODE_YUY2_PnMR		(PnDDDF_YC_PnMR | PnYCDF_YUYV_PnMR | PnBM_MD_PnMR | \
+				           PnSPIM_TPOFF_PnMR)
 
 #define PnMWR(n)	(0x00104 + 0x100 * (n)) /* plane n */
 
@@ -810,12 +816,23 @@ typedef enum {
      CARE1_PLANE_OPACITY      = 0x00000004,
 } CarE1PlaneOptions;
 
+typedef enum {
+     CARE1_FORMAT_UNKNOWN     = 0x00000000,
+
+     CARE1_FORMAT_RGB16       = 0x00000001,
+     CARE1_FORMAT_ARGB        = 0x00000002,
+     CARE1_FORMAT_UYVY        = 0x00000003,
+     CARE1_FORMAT_YUY2        = 0x00000004,
+     CARE1_FORMAT_NV12        = 0x00000005,
+     CARE1_FORMAT_NV21        = 0x00000006,
+} CarE1PlaneFormat;
+
 typedef struct {
      CarE1PlaneOptions   options;
 
      unsigned long       phys;
      int                 pitch;
-     int                 depth;
+     CarE1PlaneFormat    format;
 
      int                 x;
      int                 y;
-- 
1.7.0.4

